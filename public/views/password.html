<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>SendIT | Password recovery</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" media="screen" href="../css/font-awesome.min.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="../css/scarfold.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="../css/styles.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="../css/animate.css" />
</head>

<body>
	<div class="main">
		<header class="header align-bottom">
			<div class="header-content">
				<a href="" class="brand-name">SendIT<sup class="size-12">&trade;</sup></a>
				<div class="menu-div">
					<ul class="navbar">
						<li><a href="/" class="btn btn-link btn-sm">Home</a></li>
						<li><a href="/signin" class="btn btn-link btn-sm">Sign in</a></li>
					</ul>
				</div>
			</div>
		</header>
		<div class="row no-gutters">
			<div class="col-lg-6 offset-lg-3 col-md-10 offset-md-1 col-sm-12 offset-sm-0">
				<div class="flex justify-content-center">
					<div class="auth-container">
						<div class="auth-title">
							<h2>Reset Password</h2>
						</div>
						<div class="panel-auth">
							<form class="form-auth" action="" method="POST">
								<div class="alert alert-info">
									We will send a new password to your email
								</div>
								<div class="section">
									<div class="control-group">
										<label for="email">E-mail address</label>
										<input type="email" class="control col-12" name="email" id="email" placeholder="E-mail address"
											autocomplete="off" autofocus>
									</div>
									<div class="mb-lg align-center hide" id="success-div">
										<img class="success-img bounceInDown animated" src="../images/success.png" alt="">
										<div class="size-16 bold">Successfull!</div>
									</div>
									<div id="message"></div>
									<div class="control-group mb-sm">
										<button class="btn btn-primary btn-lg" id="submit" onclick="verifiyEmail(event)">Continue</button>
									</div>
								</div>
							</form> 
						</div>
					</div>
				</div>
			</div>
		</div>		
	</div>
	<footer class="footer mt-lg">
		<div class="footer-content align-center">
			&copy; Andela bootcamp,
			<script> document.write(new Date().getFullYear());</script>. All right reserved
		</div>
	</footer>
</body>
<script src="../js/jquery-3.2.1.min.js"></script>
<script src="../js/script.js"></script>
<script>
	const verifiyEmail = async (e) => {
		e.preventDefault();
		if (e.target.innerText === 'Continue') {
			const email = document.getElementById('email');
			const fields = [email.id];
			if (!hasEmpty(fields) && isEmail(email)) {
				processing({ start: true, message: 'Please wait...' })
				await fetch(request({ path: `/auth/email`, fields })).then(res => res.json())
					.then((res) => {
						if (res.status === 'Success') {
							document.getElementById('success-div').classList.remove('hide');
							const div = document.getElementById('email').parentElement
							$.when(addClass(div, ['zoomOut', 'animated'])).done(() => {
								div.classList.add('hide')
								resetPassword(email);
								processing({ start: false, message: 'Sign in' });
							});
						} else {
							processing({ start: false, message: 'Continue' });
							displayError(email, res.message);
						}
					})
					.catch(error => {
						processing({ start: false, message: 'Continue' });
						message(error.message, error.status)
					});
			}
		} else {
			window.location.href = '/signin';
		}
	}

	const generatePassword = () => {
		const str = 'abcdefghijklmnopqrstuvwxyz';
		const mix = str.concat(str.toUpperCase());
		let password = '';
		do {
			password = password.concat(mix[Math.floor(Math.random() * 51)]);
		} while (password.length < 12);
		return password;
	}
	const resetPassword = async (email) => {
		fetch(request({
			path: `/auth/resetPassword`,
			method: 'PUT',
			data: getFormData([email.id], (data) => {
				data.password = generatePassword();
				return data;
			})
		})).then(res => res.json())
			.then((res) => {
				const msg = `A new password was sent to <b>${email.value}</b> 
							<br/> Kindly check your inbox or spam`
				message(msg, res.status);
				email.value = '';
			})
			.catch((error) => message(error.message, error.status))
	}
</script>

</html>