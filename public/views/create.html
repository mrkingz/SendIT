<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>SendIT | Create order</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" media="screen" href="../css/font-awesome.min.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="../css/scarfold.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="../css/styles.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="../css/animate.css" />
	<script src="../js/authorization.js"></script>
</head>

<body onload="loadStates(['pick-up-state', 'destination-state'])">
	<div class="main">
		<header>
			<nav class="container navbar fixed-top">
				<div class="brand"><a href="" class="brand-name" style="color: #555;">SendIT<sup class="size-12">&trade;</sup></a></div>
				<div class="search-container">
					<div class="search-wrapper">
						<div class="search-control-container">
							<input type="text" class="track-input" placeholder="Track your parcel">
							<button class="btn btn-primary btn-sm search-btn">Track </button>
						</div>
					</div> 
				</div>
				<div class="links">
					<div class="dropdown">
						<button onclick="dropdown('menu-dropdown')" class="btn btn-transparent dropbtn"><i class="fa fa-bars"></i></button>
						<div id="menu-dropdown" class="dropdown-content size-11 align-left">
								<a href="/dashboard" class="menu-btn"><i class="fa fa-dashboard"></i> Dashboard</a>
							<a href="/create" class="menu-btn"><i class="fa fa-edit"></i> New order</a>
							<a href="/orders" class="menu-btn"><i class="fa fa-list-ol"></i> Delivery orders</a>
						</div>
					</div>
					<div class="dropdown">
						<button id="avatar" onclick="dropdown('user-dropdown');" class="btn btn-transparent dropbtn">
							<i class="fa fa-user-circle"></i> <i class="fa fa-caret-down size-18 normal ml-md"></i>
						</button>
						<div id="user-dropdown" class="dropdown-content size-11 align-left">
							<div class="panel px-md user-name">
								<div class="size-14 bold">Kingsley Frank-Demesi</div>
							</div>
							<a href="/profile" class="menu-btn"><i class="fa fa-user-o"></i> My profile</a>
							<button class="menu-btn" onclick="signout()"><i class="fa fa-sign-out"></i> Sign out</button>
						</div>
					</div>
				</div>
			</nav>
		</header>
		<div class="row no-gutters">
			<div class="col-lg-6 offset-lg-3 col-md-6 offset-md-3 col-sm-12">
				<div class="page">
					<div id="new-order">
						<div class="page-header"><span class="page-title">New delivery order</span></div>
						<form class="form mx-0" action="" method="POST">
							<div class="section">
								<div class="control-group">
									<label for="">Parcel details</label>
									<div class="panel">
										<div class="control-group">
											<label class="required" for="weight">Parcel weight</label>
											<input type="text" id="weight" class="control col-lg-5 col-md-5 col-sm-12" name="weight" placeholder="Parcel weight"
												autocomplete="off" autofocus>
										</div>
										<div class="control-group">
											<label class="required" for="description">Description</label>
											<input type="text" class="control col-lg-12 col-md-12 col-sm-12" name="description" id="description"
												placeholder="Description" autocomplete="off">
										</div>
									</div>
								</div>
								<div class="control-group">
									<label for="delivery-method">Choose your delivery method</label>
									<div id="delivery-method" class="panel">
										<div class="form-check">
											<input class="form-check-input" type="radio" id="fast" name="deliveryMethod" value="Fast">
											<label class="form-check-label" for="fast">Fast delivery</label>
										</div>
										<div class="form-check m-0">
											<input class="form-check-input" type="radio" id="normal" name="deliveryMethod" value="Normal" checked>
											<label class="form-check-label" for="normal">Normal delivery</label>
										</div>
									</div>
								</div>
								<div class="control-group">
									<label for="delivery-method">Your pick up location</label>
									<div class="panel">
										<div class="details size-12">Fill in where you want us to pick up your parcel and date</div>
										<div class="control-group">
											<label class="required" for="pick-up-address">Address</label>
											<input type="text" class="control" name="pickUpAddress" id="pick-up-address" placeholder="Address"
												autocomplete="off">
										</div>
										<div class="row">
											<div class="col-lg-6 col-md-6 col-sm-12">
												<div class="control-group">
													<label class="required" for="pick-up-state">State</label>
													<select id="pick-up-state" name="pickUpStateId" class="control" onchange="loadLGAs(event)">
														<option value="">Select state</option>
													</select>
												</div>
											</div>
											<div class="col-lg-6 col-md-6 col-sm-12">
												<div class="control-group">
													<label class="required" for="pick-up-lga">L.G. Area</label>
													<select id="pick-up-lga" name="pickUpLGAId" class="control">
														<option value="">Select L.G. Area</option>
													</select>
												</div>
											</div>
										</div>
									</div>
								</div>
								<div class="control-group">
									<label for="parcel-destination">Parcel destination</label>
									<div id="parcel-destination" class="panel">
										<div class="details size-12">
											Fill in the destination of your parcel
										</div>

										<div class="control-group">
											<label class="required" for="destination-address">Address</label>
											<input type="text" class="control" name="destinationAddress" id="destination-address" placeholder="Address"
												autocomplete="off">
										</div>
										<div class="row">
											<div class="col-lg-6 col-md-6 col-sm-12">
												<div class="control-group">
													<label class="required" for="destination-state">State</label>
													<select name="destinationStateId" id="destination-state" class="control" onchange="loadLGAs(event)">
														<option value="">Select state</option>
													</select>
												</div>
											</div>
											<div class="col-lg-6 col-md-6 col-sm-12">
												<div class="control-group">
													<label class="required" for="destination-lga">L.G. Area</label>
													<select id="destination-lga" name="destinationLGAId" class="control">
														<option value="">Select L.G. Area</option>
													</select>
												</div>
											</div>
										</div>
									</div>
								</div>
								<div class="control-group">
									<label for="parce-destination">Receiver's details</label>
									<div id="parcl-destination" class="panel">
										<div class="details size-12">Fill in receiver's details</div>
										<div class="control-group">
											<label class="required" for="receiver-name">Receicver's full name</label>
											<input type="text" class="control" name="receiverName" id="receiver-name" placeholder="Full name"
												autocomplete="off">
										</div>
										<div class="control-group">
											<label class="required" for="receiver-phone">Receicver's phone</label>
											<input type="text" class="control col-lg-8 col-md-8 col-sm-12" name="receiverPhone" id="receiver-phone"
												placeholder="Phone" autocomplete="off">
										</div>
									</div>
								</div>
								<div class="mx-lg">
									<p class="required-text">All fields marked with<strong class="required"></strong>
										are required!</p>
									<button class="btn btn-primary" onclick="create(event)">Continue</button>
								</div>
							</div><br>
						</form>
					</div>
					<div id="order-quotation">
						<div class="page-title">Confirm your order </div>
						<div class="section">
							<div class="panel" style="margin: 0 1rem">
								<div class="field">
									<div class="field-name">Weight</div>
									<div class="field-value" id="data-weight"></div>
								</div>

								<div class="field">
									<div class="field-name">Parcel description</div>
									<div class="field-value" id="data-description"></div>
								</div>

								<div class="field">
									<div class="field-name">Delivery method</div>
									<div class="field-value" id="data-deliveryMethod"></div>
								</div>

								<div class="field">
									<div class="field-name">Pick up location</div>
									<div class="field-value" id="data-pickUp"></div>
								</div>

								<div class="field">
									<div class="field-name">Parcel destination</div>
									<div class="field-value" id="data-destination"></div>
								</div>

								<div class="field">
									<div class="field-name">Estimated date of arrival</div>
									<div class="field-value red-color" id="data-estimated"></div>
								</div>
								<div class="field">
									<div class="field-name">Receiver name</div>
									<div class="field-value" id="data-receiverName"></div>
								</div>

								<div class="field">
									<div class="field-name">Receiver phone number</div>
									<div class="field-value" id="data-receiverPhone"></div>
								</div><br><br>
								<div class="div-wrapper">
									<div class="cost-wrapper">
										<div class="nexted">
											<div class="alert alert-info cost">Delivery cost: &#8358; <span id="cost"></span></div>
										</div>
									</div> 
								</div><br>
								<div id="message"></div>
								<div class="align-center">
									<button class="btn btn-primary" id="submit" onclick="submitOrder(event)">Submit</button>
									<button class="btn btn-primary-inverse" onclick="editOrder(event)">Edit
										order</button>
								</div>
							</div>
						</div>
					</div>
					<div class="section" id="order-success"><br>
						<div class="panel my-lg">
							<div id="success" class="align-center">
								<div class="mb-lg">
									<img class="success-img bounceInDown animated" src="../images/success.png" alt="">
									<div id="message"></div><br>
									<div id="trackingNo"></div>
								</div>
								<div class="section">
									<div id="info">
										<div class="alert alert-info">
											Your parcel delivery order creation was successfull. <br>
											You will be notified once processing begins... <br>
											<h3>Thanks for your patronage!</h3>
										</div>
									</div>
								</div>
								<div class="mt-lg">
									<a href="/create" class="btn btn-primary">Done</a>
								</div>
							</div>
						</div>
						<br>
					</div>
				</div>
			</div>
		</div>
	</div>
	<footer class="footer mt-lg">
		<div class="footer-content align-center">
			&copy; Andela bootcamp,
			<script>document.write(new Date().getFullYear())</script>. All right reserved
		</div>
	</footer>
	<script src="../js/jquery-3.2.1.min.js"></script>
	<script src="../js/script.js"></script>
	<script>
		let data; areas = {};
		const getAreas = (stateId, lgaId) => {
			return fetch((request({
				path: `/states/${stateId}/lgas/${lgaId}`,
				method: 'GET'
			}))).then(res => res.json());
		}
		const create = async (e) => {
			e.preventDefault();
			processing({ start: true });
			const fields = [
				'weight', 'description', 'pick-up-address', 'pick-up-lga', 'pick-up-state',
				'destination-address', 'destination-lga', 'destination-state',
				'receiver-name', 'receiver-phone'
			];
			const phone = document.getElementById('receiver-phone');
			const weigth = document.getElementById('weight')
			if (!hasEmpty(fields) && isValidWeight(weigth) && isValidPhone(phone)) {
				data = await getFormData(fields, (data) => {
					data['deliveryMethod'] = document.querySelector(`input[type='radio']:checked`).value
					return data;
				});
				let stateId = document.getElementById('pick-up-state').value;
				let lgaId = document.getElementById('pick-up-lga').value;
				await getAreas(stateId, lgaId).then(stateData => {
					const { state, lga } = stateData.data.area;
					stateId = document.getElementById('destination-state').value;
					lgaId = document.getElementById('destination-lga').value;
					areas.from = { state, lga }
					return getAreas(stateId, lgaId).then(lgaData => {
						const { area } = lgaData.data;
						areas.to = { state: area.state, lga: area.lga }
					})
				})
				await preview(JSON.parse(data));
				toggleOrder({ show: false, animation: 'bounceInRight' });
			}
		}

		const computeCost = (weight) => {
			const cost = Number(weight) * 1000;
			document.getElementById('cost').innerHTML = cost;
		}

		const preview = async (data) => {
			let elem, text;
			const elemArr = [
				'weight', 'description', 'deliveryMethod', 'pickUp',
				'estimated', 'destination', 'receiverName', 'receiverPhone'
			];
			computeCost(data.weight)
			await elemArr.forEach((str) => {
				elem = document.getElementById(`data-${str}`);
				switch (str) {
					case 'pickUp':
						text = `${data['pickUpAddress']}, ${areas.from.lga}, ${areas.from.state} State`;
						break;
					case 'destination':
						text = `${data['destinationAddress']}, ${areas.to.lga}, ${areas.to.state} State`;
						break;
					case 'estimated':
						text = `Maximum of ${(data['deliveryMethod'] === 'Fast') ? 3 : 7} days from pick up date`;
						break;
					default: text = data[str];
				}
				elem.innerHTML = text;
			})
			processing({ start: false, message: 'Continue' })
		}

		const submitOrder = async (e) => {
			e.preventDefault();
			processing({ start: true });
			await fetch(request({ path: '/parcels', data })).then(res => {
				if (res.status === 201) {
					$('input, select').val('');
					document.getElementById('normal').checked = true;
				}
				return res.json()
			})
				.then(res => {
					if (res.status === 'Success') {
						document.querySelector('#success #message').innerHTML = res.message;
						document.getElementById('trackingNo').innerHTML = res.data.parcel.trackingNo;
						const orderQuote = document.getElementById('order-quotation');
						const orderSuccess = document.getElementById('order-success');
						toggleOrderSteps(orderQuote, false, ['bounceOut', 'Animated']).then(() => {
							toggleOrderSteps(orderSuccess, true, ['bounceIn', 'animated'])
						})
					} else {
						message(res.message, res.status, null, true, 'shake');
					}
				})
				.catch(error => {
					message(error.message, error.status, null, true, 'shake')
				})
			processing({ message: 'Submit', start: false });
		};

		const editOrder = (e) => {
			e.preventDefault();
			toggleOrder({ show: true, animation: 'bounceInLeft' });
		};
	</script>
</body>

</html>