<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>SendIT | Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" media="screen" href="../css/font-awesome.min.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="../css/scarfold.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="../css/styles.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="../css/animate.css" />
  <script src="../js/authorization.js"></script>
</head>

<body onload="getProfileDetails()">
  <header class="header align-bottom">
    <div class="header-content">
      <a href="" class="brand-name">SendIT<sup class="size-12">&trade;</sup></a>
      <div class="menu-div">
        <ul class="navbar">
          <li><a href="/dashboard" class="btn btn-link btn-sm red-color">Dashboard</a></li>
          <li><a href="/" class="btn btn-link btn-sm red-color">Sign out</a></li>
        </ul>
      </div>
    </div>
  </header>
  <div class="row no-gutters">
    <div class="col-lg-10 offset-lg-1 col-md-10 offset-md-1 col-sm-12 offset-sm-0">
      <div class="wrapper mx-0 mb-0">
        <div class="row">
          <div class="col-lg-3 col-md-3 col-sm-12 bg-white">
            <div class="align-center panel">
              <div class="image-div mb-lg avatar-wrapper">
                <img src="../images/avatar.png" alt="" class="side-image avatar">
              </div>
              <div class="size-12 more-details">
                <div id="name" class="bold my-lg" style="font-size: 20px;"></div>
                <div id="role"></div>
              </div>
            </div>
          </div>
          <div class="col-lg-6 col-md-6 col-sm-12">
            <div style="padding-bottom: 30px">
              <div class="content-header">Profile info</div>
              <div class="panel">
                <div class="dropdown">
                  <button onclick="dropdown('menu')" class="btn btn-link dropbtn btn-sm"><i class="fa fa-bars"></i></button>
                  <div id="menu" class="dropdown-content size-11 dropdown-content-mini">
                    <button class="menu-btn" onclick="editNameModal(event, user)">Update name</button>
                    <button class="menu-btn" id="phone-btn" onclick="updatePhoneModal(event, user)">Update phone number</button>
                    <button class="menu-btn" onclick="changePasswordModal(event, user)">Change password</button>
                  </div>
                </div>
              </div>
              <div class="panel">
                <div class="profile-div">
                  <div class="row no-gutters">
                    <div class="col-lg-12 col-md-12 col-sm-12">
                      <div class="data-wrapper">
                        <div class="data-row">
                          <label for="firstname" class="data-label">Firstname</label>
                          <div class="data-value" id="data-firstname"></div>
                        </div>
                        <div class="data-row">
                          <label for="firstname" class="data-label">Lastname</label>
                          <div class="data-value" id="data-lastname"></div>
                        </div>
                        <div class="data-row">
                          <label for="firstname" class="data-label">E-mail address</label>
                          <div class="data-value" id="data-email"></div>
                        </div>
                        <div class="data-row">
                          <label for="firstname" class="data-label">Phone number</label>
                          <div class="data-value" id="data-phonenumber">--</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="mt-lg height-transition" id="orders"></div>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-3 col-sm-12 bg-white">
          </div>
        </div>
      </div>
    </div>
  </div>
  <footer class="footer mt-lg">
    <div class="footer-content align-center">
      &copy; Andela bootcamp,
      <script>document.write(new Date().getFullYear())</script>. All right reserved
    </div>
  </footer>

  <script src="../js/jquery-3.2.1.min.js"></script>
  <script src="../js/script.js"></script>
  <script src="../js/modals.js"></script>
  <script>
    let user;
    const getProfileDetails = async () => {
      await fetch(request({
        path: `/auth/profileDetails`,
        token: localStorage.getItem('token'),
        method: 'GET'
      })).then(res => res.json())
        .then((res) => {
          user = res.data.user;
          orderBreakdown(res.data.user.orders, user.userid);
          Object.keys(user).forEach((key) => {
            elem = document.getElementById(`data-${key}`);
            if (elem && user[key] !== '') {
              elem.innerText = user[key];
            }
          });
        })
    }

    const updateName = (e) => {
      e.preventDefault();
      const fields = ['firstname', 'lastname']
      if (!hasEmpty(fields)) {
        updateRequest({
          path: `/auth/editName`,
          data: getFormData(fields),
        })
      }
    }

    const updatePhone = () => {
      updateRequest({
        path: `/auth/phoneNumber`,
        data: getFormData(['phone-number'])
      });
    };

    const changePassword = (e) => {
      e.preventDefault();
      if (e.target.innerText !== 'Save') {
        const fields = ['current-password'];
        if (!hasEmpty(fields, 'Enter current password')) {
          processing({ start: true, message: 'Verifying...' });
          fetch(request({
            path: '/auth/verifyPassword', fields, token: localStorage.getItem('token'),
          })).then(res => res.json())
            .then((res) => {
              if (res.status === 'Success') {
                addClass(document.getElementById('current-div'), ['zoomOut', 'animated', 'hide']);
                document.getElementById('new-div').classList.add('show');
                document.querySelector('.modal').classList.add('static');
                processing({ start: false, message: 'Save' });
              } else {
                displayError(document.getElementById(fields[0]), res.message);
                processing({ start: false, message: 'Continue' })
              }
            })
        }
      } else if (!hasEmpty(['new-password'])
        && isValidPassword(document.getElementById('new-password'))
        && !hasEmpty(['confirm-password']) && comparePassword()) {
        updateRequest({
          path: `/auth/changePassword`,
          data: getFormData(['new-password'])
        })
      }
    }

    const comparePassword = () => {
      const newPass = document.getElementById('new-password');
      const confirmPass = document.getElementById('confirm-password');
      if (newPass.value !== confirmPass.value) {
        displayError(newPass, 'Sorry, password does not match');
        confirmPass.value = '';
        return false;
      }
      return true;
    }

    const orderBreakdown = (data, userId) => {
      let content = `<div class="alert alert-info size-13 my-lg">You currently have no delivery orders. <br> Click below to create<br/>
                      <a href="/create" class="btn btn-link bold fine-btn mt-lg">Create Order</a>
                      </div>`;
      if (data.total > 0) {
        content = `<div class="more-details mb-md">
                    <div class="nexted">
                      <div class="card-header flex justify-content-between">
                        <div class="card-title">
                          <label class="size-12 bold">Delivery orders</label>
                        </div>
                      </div>
                      <div class="card-wrapper">
                        <div class="card-row">
                          <div class="data-header">Cancelled orders</div>
                          <div class="data" id="data-cancelled">${data.cancelled}</div>
                        </div>
                        <div class="card-row">
                          <div class="data-header">Delivered orders</div>
                          <div class="data" id="data-delivered">${data.delivered}</div>
                        </div>
                        <div class="card-row">
                          <div class="data-header">Transiting orders</div>
                          <div class="data" id="data-transiting">${data.transiting}</div>
                        </div>
                        <div class="card-row">
                          <div class="data-header">Placed orders</div>
                          <div class="data" id="data-placed">${data.placed}</div>
                        </div>
                        <div class="card-row">
                          <div class="data-header red-colo" style="font-size: 1.5rem">Total</div>
                          <div class="data red-color bold" id="data-total" style="font-size: 1.5rem">${data.total}</div>
                        </div>
                      </div>
                      <div class="more-detail mt-lg align-right">
                        <a href="/users/orders" class="btn btn-primary btn-block btn-lg">View orders</a>
                      </div>
                    </div>
                </div>`;
      }
      const orders = document.getElementById('orders');
      orders.innerHTML = content;
      orders.style.maxHeight = '500px';
    }
  </script>
</body>

</html>